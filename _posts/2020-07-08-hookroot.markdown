---
layout:	post
title:	"Android-ç»•è¿‡rootæ£€æµ‹"
date:	2020-07-08 18:00:09 +0800
tags:	Android
color:	rgb(50,205,50)
cover:	'../assets/blog_pic/20200708_hookroot/cover.png'
subtitle:	'rootï¼Ÿhook'

---

* ç›®å½•
{:toc}
æœ‰äº›appå®‰è£…åˆ°å·²rootçš„æ‰‹æœºä¸Šä¼šæç¤ºæ‰‹æœºè¢«rootï¼Œä¸èƒ½ä½¿ç”¨ğŸ™„é‚£è¿˜å«äººæ€ä¹ˆç©å•Šï¼Œæ‘”

![avatar](../../assets/blog_pic/20200708_hookroot/root.png)

ç„¶åé€šè¿‡å„ç§å¥—å¨ƒåˆ«äººçš„æ–¹æ³•ï¼Œæ¥ç»•è¿‡ä¸€ä¸‹



# ç¯å¢ƒè¯´æ˜

| ç¯å¢ƒ    | ç‰ˆæœ¬            |
| ------- | --------------- |
| win     | 10              |
| android | å¤œç¥æ¨¡æ‹Ÿå™¨å®‰å“7 |
| frida   | 12.10.4         |



# å®‰è£…frida

**Frida**æ˜¯ä¸€æ¬¾åŸºäºpython + javascript çš„hookæ¡†æ¶ï¼Œé€‚ç”¨äºandroid/ios/linux/win/osxç­‰å¹³å°ã€‚**Frida**çš„åŠ¨æ€ä»£ç æ‰§è¡ŒåŠŸèƒ½ï¼Œä¸»è¦æ˜¯åœ¨å®ƒçš„æ ¸å¿ƒå¼•æ“Gumä¸­ç”¨Cè¯­è¨€æ¥å®ç°çš„ã€‚ï¼ˆæŠ„çš„

## å®‰è£…fridaå®¢æˆ·ç«¯

ç”¨**pip**å°±å¯ä»¥å®‰è£…**frida**

```
Î» pip install frida
```

ä½†æ˜¯æˆ‘æ²¡æˆåŠŸï¼Œå¯ä»¥å‡çº§**pip**è¯•ä¸€ä¸‹ï¼Œä¹Ÿå¯ä»¥å°è¯•

```
Î» pip install frida-tools
```

ä½†æ˜¯æˆ‘æ²¡æˆåŠŸï¼Œæœ€ç»ˆæˆ‘åœ¨ç®¡ç†å‘˜æƒé™ä¸‹ï¼ŒæˆåŠŸäº†ğŸ˜‘

```
Î» frida --version
12.10.4
```

å°±è¯´æ˜ä½ æ‹¥æœ‰äº†**frida**ğŸ’¥

## å®‰è£…fridaæœåŠ¡ç«¯

é¦–å…ˆ[é€‰æ‹©](https://github.com/frida/frida/releases/)åˆé€‚çš„**frida-server**ï¼Œæ€ä¹ˆé€‰å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ç”¨**adb**æŸ¥çœ‹æˆ‘ä»¬çš„æ‰‹æœºæ˜¯ä»€ä¹ˆ**cpu**ç‰ˆæœ¬

ç”¨**adb**è¿æ¥æ‰‹æœºï¼Œæˆ‘è¿™é‡Œæ˜¯å¤œç¥æ¨¡æ‹Ÿå™¨ï¼Œè¿›å…¥æ¨¡æ‹Ÿå™¨å®‰è£…æ‰€åœ¨æ–‡ä»¶å¤¹

```
Î» nox_adb.exe connect 127.0.0.1:62026
already connected to 127.0.0.1:62026
```

æŸ¥çœ‹æ˜¯å¦è¿æ¥

```
Î» nox_adb.exe devices
List of devices attached
127.0.0.1:62026 device
```

è¿›å…¥æŸå°æ‰‹æœºï¼š

```
Î» adb -s 127.0.0.1:62026 shell
```

æŸ¥çœ‹**cpu**ç‰ˆæœ¬ï¼š

```
R11:/ # getprop ro.product.cpu.abi
x86
```

æ˜¯**x86**ï¼Œé‚£å°±é€‰æ‹©å¯¹åº”çš„å¦‚å›¾ä¸‹è½½

![avatar](../../assets/blog_pic/20200708_hookroot/x86.png)

è§£å‹åå°†æ–‡ä»¶æ”¾å…¥æ‰‹æœº

```
Î» adb push frida-server-12.10.4-android-x86 /data/local/tmp
[100%] /data/local/tmp/frida-server-12.10.4-android-x86
```

è®¾ç½®ç«¯å£è½¬å‘åˆ°**pcç«¯**

```
Î» adb forward tcp:27042 tcp:27042

Î» adb forward tcp:27043 tcp:27043
```

å†æ¬¡è¿›å…¥æ‰‹æœºï¼Œä¿®æ”¹**frida-server**æƒé™ï¼Œå¯åŠ¨**frida**

```
Î» adb shell
R11:/ # cd /data/local/tmp
R11:/data/local/tmp # ls
frida-server-12.10.4-android-x86
R11:/data/local/tmp # chmod 755 frida-server-12.10.4-android-x86
R11:/data/local/tmp # ./frida-server-12.10.4-android-x86
```

å†æ‰“å¼€å¦ä¸€ä¸ª**cmd**ï¼š

```
Î» frida-ps -U
```

å¦‚æœå‡ºç°Androidçš„è¿›ç¨‹ï¼Œåˆ™ä»£è¡¨å®‰è£…æˆåŠŸã€‚

![avatar](../../assets/blog_pic/20200708_hookroot/psu.png)



# å¦‚ä½•hook

æˆ‘ä»¬é‡åˆ°çš„é—®é¢˜æ˜¯**app**åˆšå¯åŠ¨æ£€æµ‹åˆ°**root**å°±å…³æ‰ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å¯»æ‰¾æ˜¯åœ¨å“ªæ£€æµ‹åˆ°**root**çš„ï¼Œè¿™æ˜¯é—®é¢˜çš„åˆ‡å…¥ç‚¹

äºŒè¯ä¸è¯´æå‡ºapkåç¼–è¯‘ï¼ˆå¦‚æœä½ æ‰‹é‡Œçš„apkå› ä¸ºè¢«åŠ å›ºäº†ç­‰æƒ…å†µæ— æ³•åç¼–è¯‘ï¼Œå‡ºé—¨å·¦è½¬å†è§

## çµ®çµ®å¨å¨å¦‚ä½•åç¼–è¯‘

æŠŠ**apk**çš„åç¼€æ”¹ä¸º**zip**ï¼Œè¿›è¡Œè§£å‹ï¼Œè§£å‹åæ‰“å¼€æ‰¾åˆ°**dex**åç¼€çš„æ–‡ä»¶

![avatar](../../assets/blog_pic/20200708_hookroot/dex.png)

ç”¨**dex2jar**åç¼–è¯‘

```
Î» d2j-dex2jar.bat classes.dex
```

ä¼šç”Ÿæˆä¸€ä¸ª**jar**æ–‡ä»¶ï¼Œè¿™é‡Œæ˜¯**classes-dex2jar.jar**

ç„¶åç”¨**jadx-gui**æ‰“å¼€

![avatar](../../assets/blog_pic/20200708_hookroot/jadx.png)

## å®šä½å‡½æ•°

å…¨å±€æœç´¢**æ‰‹æœºå·²è¢«ROOTï¼Œè¯·æ³¨æ„ä½¿ç”¨å®‰å…¨**ï¼Œæˆ‘ä»¬å‘ç°ç¡®æœ‰æ­¤å¥

![avatar](../../assets/blog_pic/20200708_hookroot/message.png)

è¿™é‡Œçš„é€»è¾‘å°±æ˜¯ï¼Œå¦‚æœ**c**ï¼Œé‚£å°±å¼¹æ¡†è¿™å¥è¯ï¼Œé‚£ä¹ˆ**c**çš„æ„æ€ï¼Ÿå¤§æ¦‚å°±æ˜¯åˆ¤æ–­æ‰‹æœºæ˜¯å¦è¢«**root**äº†ï¼Œæˆ‘ä»¬å‘ç°ç¡®æœ‰æ­¤**c**

![avatar](../../assets/blog_pic/20200708_hookroot/c.png)

å¦‚æœå­˜åœ¨è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼Œè¯´æ˜æ‰‹æœºè¢«**root**äº†ï¼Œä¸å­˜åœ¨å°±è¿”å›**false**

## ç¼–å†™js

**hookroot.js**ï¼š

```
Java.perform(function x() {
    var application = Java.use("android.app.Application");
    application.attach.overload('android.content.Context').implementation = function (context) {
        var result = this.attach(context);
        var classloader = context.getClassLoader();
        Java.classFactory.loader = classloader;
        var funk = Java.classFactory.use("com.xxx.xxx.xxx.xxx.HomeActivity");
        funk.c.overload().implementation = function () {
            return false;
        }		
    }
});
```

**com.xxx.xxx.xxx.xxx.HomeActivity**æ˜¯æˆ‘ä»¬é‚£ä¸ªå‡½æ•°æ‰€åœ¨çš„**class**

**funk.c**æ˜¯æˆ‘ä»¬å®šä½åˆ°è¯†åˆ«**root**ï¼Œè®©ä»–è¿”å›**false**



## å¼€å§‹hook

å…ˆæ‰“å¼€**app**ï¼Œç•Œé¢è¿˜æ˜¯**æ‰‹æœºå·²è¢«ROOTï¼Œè¯·æ³¨æ„ä½¿ç”¨å®‰å…¨**

æ­¤æ—¶ï¼Œ**frida**å¯åŠ¨**hook**

```
Î» frida -U -f com.xxx.xxx.xxx -l hookroot.js
```

**com.xxx.xxx.xxx**æ˜¯æˆ‘ä»¬çš„**apk**åŒ…å

çœ‹åˆ°**frida**å¯åŠ¨ï¼Œ**app**å…³é—­ï¼Œæç¤º

```
Use %resume to let the main thread start executing!
```

ç„¶åæ ¹æ®æç¤ºè¾“å…¥

```
%resume
```

![avatar](../../assets/blog_pic/20200708_hookroot/resume.png)

**app**å¯åŠ¨åå°±æ²¡æœ‰**root**æç¤ºï¼Œå¯ä»¥æ­£å¸¸ç™»å½•äº†ğŸ‘¶

# Refer

[https://www.jianshu.com/p/c349471bdef7](fuzhi)

[https://www.cnblogs.com/luoyesiqiu/p/10718997.html](zhantie)

[https://blog.csdn.net/cjx529377/article/details/95802532](ï¼Ÿ)